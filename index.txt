<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>飞机大战</title>
    <style>
        .container{
            width:600px;
            height:720px;
            background: #fffdfd;
            margin: 100px auto;
            position: relative;
            overflow: hidden;
        }
        .enemy{
            position: absolute;
            z-index: 1;

        }
        #myplane{
            position: absolute;
            bottom:10px;
            left: 275px;
        }
    </style>
    <script>

        function keydownEvent(e) {    <!-- 按下键盘后接收的函数-->
            var ev = e || event;
            var keyCode = ev.keyCode;

            console.log(keyCode);
            <!--根据keyCode的不同判断飞机往哪飞-->

            if(keyCode == Contances.W_KEYCODE){
                goingUp = true;
            }

            if(keyCode == Contances.S_KEYCODE){
                goingDown = true;
            }

            if(keyCode == Contances.D_KEYCODE){
                goingRight = true;
            }

            if(keyCode == Contances.A_KEYCODE){
                goingLeft = true;
            }



            console.log(ev);

        }

        function keyupEvent(e) {    <!-- 按下键盘后接收的函数-->
            var ev = e || event;
            var keyCode = ev.keyCode;

            console.log(keyCode);
            <!--根据keyCode的不同判断飞机往哪飞-->
            if(keyCode == Contances.W_KEYCODE){
                goingUp = false;
            }

            if(keyCode == Contances.D_KEYCODE){
                goingRight = false;
            }

            if(keyCode == Contances.A_KEYCODE){
                goingLeft = false;
            }

            if(keyCode == Contances.S_KEYCODE){
                goingDown = false;
            }
        }

        //设置游戏的帧动画定时器
        var gameInterval = setInterval(function () {

            if(goingUp){
                <!--w飞机正在向上飞-->
                var y = getY($(planeId)) + Contances.STEP;     <!--获取原来的bottom-->


                //边界碰撞检测
                if(y > Contances.BG_HEIGHT-Contances.PLANE_HEIGHT){      <!--如果到头就返回-->
                    return;
                }

                setY($(planeId),y);        <!--更改oldBottom的值，重新赋值-->
            }

            if(goingDown){
                <!--s飞机正在向下飞-->
                var y = getY($(planeId)) - Contances.STEP;     <!--获取原来的bottom-->

                if(y < 0){      <!--如果到头就返回-->
                    return;
                }

                setY($(planeId),y);        <!--更改oldBottom的值，重新赋值-->
            }

            if(goingLeft){
                <!--a飞机正在向左飞-->
                var x = getX($(planeId)) - Contances.STEP;     <!--获取原来的x-->

                if(x < 0){      <!--如果到头就返回-->
                    return;
                }

                setX($(planeId),x);        <!--更改x的值，重新赋值-->
            }

            if(goingRight){
                <!--d飞机正在向右飞-->
                var x = getX($(planeId)) + Contances.STEP;     <!--获取原来的x-->

                if(x > Contances.BG_WIDTH-Contances.PLANE_WIDTH){      <!--如果到头就返回-->
                    return;
                }

                setX($(planeId),x);        <!--更改x的值，重新赋值-->
            }
            //扫描全局所有的子弹，让子弹快乐的飞吧
            var bullets = document.getElementsByClassName('bullet');
            if(bullets){

                for(var i=0;i<bullets.length;i++){
                    var y = getY(bullets[i])+Contances.BULLET_STEP;
                    if(y>Contances.BG_HEIGHT){
                        $('container').removeChild(bullets[i]);
                        //console.log('子弹已经越界，销毁成功!');
                        continue;

                    }

                    setY(bullets[i],y);
                    //扫描所有的子弹是否和敌机有发生碰撞
                    //遍历所有的敌机
                    var enemies = document.getElementsByClassName("enemy");
                    for(var j=0;j<enemies.length;j++){
                        var x1=getX(enemies[j]);
                        var y1=getY(enemies[j]);
                        // console.log(x1,y1);

                        var x2=getX(bullets[i]);
                        var y2=y;
                        // console.log(x2,y2);
                        if(Math.abs(x1-x2)<Contances.ENEMY_WIDTH&&Math.abs(y1-y2)<Contances.ENEMY_HEIGHT){
                            // console.log("打中啦!！！");
                            enemies[j].src = "img/boom.png";
                            // clearInterval(bulletTimer);
                            // clearInterval(gameInterval);

                            // $('container').removeChild(enemies[j]);

                            var currentScore = $('score').innerHTML - 0;
                            currentScore+=100;

                            //if(currentScore>1000) Contances.ENEMY_STEP = Math.floor(currentScore / 1000);

                            if(currentScore < 1000){
                                Contances.ENEMY_STEP = 1;
                            }else if(currentScore < 5000){
                                Contances.ENEMY_STEP = 2;
                            }else if(currentScore < 8000){
                                Contances.ENEMY_STEP = 3;
                            }else if(currentScore < 12000){
                                Contances.ENEMY_STEP = 4;
                            }else if(currentScore < 16000){
                                Contances.ENEMY_STEP = 5;
                            }else{
                                Contances.ENEMY_STEP = 5.5;
                            }

                            Contances.ENEMY_APPEAR_FREQ -= Math.floor(currentScore / 100);
                            if(Contances.ENEMY_APPEAR_FREQ < 50){
                                Contances.ENEMY_APPEAR_FREQ = 50;
                            }
                            $('score').innerHTML = currentScore;


                        }

                        //检测敌机是否与主机发生了碰撞

                        var x3 = getX($(planeId));
                        var y3 = getY($(planeId));

                        if(Math.abs(x1-x3)<Contances.ENEMY_WIDTH && Math.abs(y1-y3)<Contances.ENEMY_HEIGHT){
                            console.log('打中本机了！');
                            var score = $('score').innerHTML;


                            var s = document.getElementById("score")
                            location.href="end.html?"+"score="+encodeURI(score);


                            //$('container').innerHTML = "<p style='color: red;text-align: center; font-size: 36px; '><b>胜败乃兵家常事，大侠请重新来过！</b></p>";
                            /*clearInterval(bulletTimer);
                            clearInterval(gameInterval);
                            clearInterval(enemyTimer);
                            clearInterval(t1);
                            clearInterval(t2);*/

                            //location.reload();



                            //记录当前的分数
                            //$('container').innerHTML +="<p style='color: green;text-align: center; font-size: 36px; '><b>您本次游戏的分数为:"+score+"</b></p>"

                        }

                    }

                }

            }

            time += 0.1;


        },42);
        // <img style="position: absolute;left:25px ;bottom: 60px;" src="img/子弹.jpg"/>
        //设置定时器，动态绘制子弹(setTimeout只发一颗子弹，setInterval一直发)
        var bulletTimer= setInterval(function () {
            var bulletX=getX($(planeId))+Contances.PLANE_WIDTH/2-4;
            var bulletY=getY($(planeId))+Contances.PLANE_HEIGHT;
            $('container').innerHTML+="<img class='bullet' style=\"position: absolute;left:"+bulletX+"px ;bottom: "+bulletY+"px;\" src=\"img/子弹4.png\"/>";
        },300);

        //敌机的移动方法
        var enemyTimer = setInterval(function () {
            //console.log(10 * Math.sin(time));
            var enemies = document.getElementsByClassName('enemy');

            for(var i=0;i<enemies.length;i++){

                var y = getY(enemies[i])-Contances.ENEMY_STEP;
                setY(enemies[i],y);

                if(y<0 -Contances.ENEMY_HEIGHT){
                    $('container').removeChild(enemies[i]);
                    return;
                }
                var roll=enemies[i].attributes.roll.value;
                //console.log(roll);
                if(roll==1){
                    var x = getX(enemies[i]);
                    x = x + 10 * Math.sin(time);
                    setX(enemies[i],x);
                }
                //if(Math.floor(100 * Math.random()) % 2){
                /*var x = getX(enemies[i]);
                x = x + 22 * Math.sin(time);
                setX(enemies[i],x);*/
                // }


            }


        },30);

        //定时清理爆炸的敌机图片
        var t1 = setInterval(function () {
            var enemies = document.getElementsByClassName('enemy');

            for(var i=0;i<enemies.length;i++){
                if(enemies[i].src.indexOf("img/boom.png")!=-1){
                    $('container').removeChild(enemies[i]);

                }
            }
        },200);//0.5秒回收一次


        //自动刷新敌机的方法

        var t2 = setInterval(function () {

            var x= Math.floor(578 * Math.random());
            var roll=0;
            if(Math.sin(x)>0){
                roll=1;
            }
            $('container').innerHTML += "<img roll='"+roll+"' class=\"enemy\" style=\"left: "+x+"px;bottom: 700px;\" src=\"img/敌机2.png\" /> ";

        },500);

    </script>
    <script src="engins.js"></script>
</head>
<body onkeydown="keydownEvent()" onkeyup="keyupEvent()">  <!-- 设置按下键盘的时间-->
<div class="container" id="container">

    <div id="score" style="text-align: right;position:absolute;right:0;padding:8px;font-size: 28px; color: white">0</div>


    <img src="img/游戏背景.jpg" height="720" width="600"/>

    <div id="myplane" style="width:60px;left:120px;bottom:10px;">

        <img  style="width: 100%;"  src="img/飞机3-1.png" />


    </div>



</div>
</body>
</html>